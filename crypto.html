<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kursy i wykresy kryptowalut</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: sans-serif; background: #0e0f12; color: #e7e9ee; margin: 0; padding: 20px; }
    h1 { margin-top: 0; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #2a2f3a; }
    th { text-align: left; color: #9aa2b1; }
    .pos { color: #1dbf73; }
    .neg { color: #f05454; }
    .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
    .chart-box { background: #151821; padding: 10px; border-radius: 8px; }
    .chart-title { margin: 0 0 8px; font-weight: bold; }
    .chart { height: 300px; }
  </style>
</head>
<body>
  <h1>Kursy kryptowalut + wykresy świecowe</h1>
  <table id="prices">
    <thead>
      <tr><th>Waluta</th><th>Cena (USD)</th><th>Zmiana 24h</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="charts">
    <div class="chart-box">
      <div class="chart-title">BTC/USDT</div>
      <div id="chart-btc" class="chart"></div>
    </div>
    <div class="chart-box">
      <div class="chart-title">ETH/USDT</div>
      <div id="chart-eth" class="chart"></div>
    </div>
    <div class="chart-box">
      <div class="chart-title">SOL/USDT</div>
      <div id="chart-sol" class="chart"></div>
    </div>
  </div>

  <script>
    // --- Tabela kursów z CoinGecko ---
    const coins = ['bitcoin', 'ethereum', 'tether', 'binancecoin', 'solana'];
    const tbody = document.querySelector('#prices tbody');
    const nfUSD = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'USD' });

    async function loadPrices() {
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coins.join(',')}&vs_currencies=usd&include_24hr_change=true`;
      const res = await fetch(url);
      const data = await res.json();
      tbody.innerHTML = '';
      coins.forEach(id => {
        const c = data[id];
        const change = c.usd_24h_change.toFixed(2);
        const cls = change >= 0 ? 'pos' : 'neg';
        tbody.innerHTML += `<tr>
          <td>${id}</td>
          <td>${nfUSD.format(c.usd)}</td>
          <td class="${cls}">${change}%</td>
        </tr>`;
      });
    }
    loadPrices();
    setInterval(loadPrices, 60000);

    // --- Funkcja tworząca wykres świecowy ---
    function createLiveChart(containerId, symbol) {
      const chart = LightweightCharts.createChart(document.getElementById(containerId), {
        layout: { background: { color: '#151821' }, textColor: '#e7e9ee' },
        grid: { vertLines: { color: '#2a2f3a' }, horzLines: { color: '#2a2f3a' } },
        timeScale: { timeVisible: true, secondsVisible: false }
      });
      const candleSeries = chart.addCandlestickSeries({
        upColor: '#1dbf73', downColor: '#f05454',
        borderDownColor: '#f05454', borderUpColor: '#1dbf73',
        wickDownColor: '#f05454', wickUpColor: '#1dbf73'
      });

      // Pobranie ostatnich świec
      fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m&limit=100`)
        .then(r => r.json())
        .then(data => {
          const candles = data.map(c => ({
            time: c[0] / 1000,
            open: parseFloat(c[1]),
            high: parseFloat(c[2]),
            low: parseFloat(c[3]),
            close: parseFloat(c[4])
          }));
          candleSeries.setData(candles);
        });

      // WebSocket live
      const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@kline_1m`);
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const k = msg.k;
        candleSeries.update({
          time: k.t / 1000,
          open: parseFloat(k.o),
          high: parseFloat(k.h),
          low: parseFloat(k.l),
          close: parseFloat(k.c)
        });
      };
    }

    // Tworzymy wykresy
    createLiveChart('chart-btc', 'BTCUSDT');
    createLiveChart('chart-eth', 'ETHUSDT');
    createLiveChart('chart-sol', 'SOLUSDT');
  </script>
</body>
</html>
